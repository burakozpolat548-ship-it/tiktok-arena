<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>√á√∂l Kale Sava≈üƒ±</title>
<style>
body{
  margin:0;
  background:linear-gradient(#e2b86b,#cfa158);
  overflow:hidden;
  font-family:sans-serif;
}
#battlefield{
  position:relative;
  width:100vw;
  height:100vh;
}
.castle{
  position:absolute;
  font-size:50px;
}
#redCastle{left:5%;top:50%}
#blueCastle{right:5%;top:30%}
#greenCastle{right:5%;top:70%}

.soldier{
  position:absolute;
  font-size:20px;
}

.health{
  position:absolute;
  font-weight:bold;
  font-size:18px;
}

#winner{
  position:absolute;
  top:40%;
  width:100%;
  text-align:center;
  font-size:60px;
  font-weight:bold;
  display:none;
  animation:glow 1s infinite alternate;
}
@keyframes glow{
  from{ text-shadow:0 0 10px white }
  to{ text-shadow:0 0 30px yellow }
}
</style>
</head>
<body>

<div id="battlefield">
  <div id="redCastle" class="castle">üè∞</div>
  <div id="blueCastle" class="castle">üè∞</div>
  <div id="greenCastle" class="castle">üè∞</div>

  <div id="winner"></div>
</div>

<script>
let state=null
let soldiers=[]

async function fetchState(){
  const res=await fetch("/state")
  state=await res.json()
}

function render(){
  document.querySelectorAll(".soldier").forEach(e=>e.remove())

  for(let team in state){
    state[team].soldiers.forEach(s=>{
      const el=document.createElement("div")
      el.className="soldier"
      el.innerText="‚öîÔ∏è"
      el.style.left=s.x+"%"
      el.style.top=s.y+"%"
      el.style.color=team
      document.body.appendChild(el)
    })
  }
}

function update(){
  for(let team in state){
    if(!state[team].alive) continue

    state[team].soldiers.forEach(s=>{
      if(team==="red") s.x+=0.5
      else s.x-=0.5

      const enemies=Object.keys(state)
        .filter(t=>t!==team && state[t].alive)

      if(enemies.length===0){
        declareWinner(team)
      }

      enemies.forEach(enemy=>{
        state[enemy].soldiers.forEach(es=>{
          if(Math.abs(s.x-es.x)<1 && Math.abs(s.y-es.y)<1){
            s.hp=0
            es.hp=0
          }
        })
      })

      if(s.x<5 || s.x>95){
        const target=team==="red"?"blue":"red"
        if(state[target]){
          state[target].health-=1
          if(state[target].health<=0){
            state[target].alive=false
          }
        }
      }
    })

    state[team].soldiers=state[team].soldiers.filter(s=>s.hp>0)
  }
}

function declareWinner(team){
  document.getElementById("winner").style.display="block"
  document.getElementById("winner").innerText=
    "üî• "+team.toUpperCase()+" TAKIMI ZAFER KAZANDI üî•"

  setTimeout(()=>location.reload(),5000)
}

async function gameLoop(){
  await fetchState()
  update()
  render()
  requestAnimationFrame(gameLoop)
}

gameLoop()
</script>
</body>
</html>
