<script>

let soldiers=[]
let lastScore={red:0,blue:0,green:0}

function spawnSoldier(team, amount){
  for(let i=0;i<amount;i++){
    const s=document.createElement("div")
    s.className="soldier"
    s.innerText="ðŸ—¡ï¸"

    if(team=="red"){
      s.style.left="10%"
      s.style.top=(45 + Math.random()*10) + "%"
      s.dataset.dx=0.3
    }

    if(team=="blue"){
      s.style.left="80%"
      s.style.top=(25 + Math.random()*10) + "%"
      s.dataset.dx=-0.3
    }

    if(team=="green"){
      s.style.left="80%"
      s.style.top=(65 + Math.random()*10) + "%"
      s.dataset.dx=-0.3
    }

    s.dataset.team=team
    document.getElementById("battlefield").appendChild(s)
    soldiers.push(s)
  }
}

function moveSoldiers(){
  soldiers.forEach((s)=>{
    let x=parseFloat(s.style.left)
    x+=parseFloat(s.dataset.dx)
    s.style.left=x+"%"
  })

  checkCollision()
}

function checkCollision(){
  for(let i=0;i<soldiers.length;i++){
    for(let j=i+1;j<soldiers.length;j++){
      const a=soldiers[i]
      const b=soldiers[j]

      if(a.dataset.team!==b.dataset.team){
        const ax=a.getBoundingClientRect()
        const bx=b.getBoundingClientRect()

        if(Math.abs(ax.left-bx.left)<10){
          a.remove()
          b.remove()
          soldiers.splice(j,1)
          soldiers.splice(i,1)
          return
        }
      }
    }
  }
}

async function update(){
  const res=await fetch("/teams")
  const data=await res.json()

  if(data.red>lastScore.red){
    spawnSoldier("red", data.red-lastScore.red)
    lastScore.red=data.red
  }

  if(data.blue>lastScore.blue){
    spawnSoldier("blue", data.blue-lastScore.blue)
    lastScore.blue=data.blue
  }

  if(data.green>lastScore.green){
    spawnSoldier("green", data.green-lastScore.green)
    lastScore.green=data.green
  }
}

setInterval(update,1000)
setInterval(moveSoldiers,40)

</script>
