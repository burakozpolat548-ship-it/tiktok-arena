<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>√á√∂l Kale Sava≈üƒ±</title>
<style>
body{
  margin:0;
  background:linear-gradient(#e2b86b,#cfa158);
  overflow:hidden;
  font-family:sans-serif;
}
#battlefield{
  position:relative;
  width:100vw;
  height:100vh;
}
.castle{
  position:absolute;
  font-size:50px;
}
#redCastle{left:5%;top:50%}
#blueCastle{right:5%;top:30%}
#greenCastle{right:5%;top:70%}

.soldier{
  position:absolute;
  font-size:20px;
}

#winner{
  position:absolute;
  top:40%;
  width:100%;
  text-align:center;
  font-size:60px;
  font-weight:bold;
  display:none;
  color:white;
}
</style>
</head>
<body>

<div id="battlefield">
  <div id="redCastle" class="castle">üè∞</div>
  <div id="blueCastle" class="castle">üè∞</div>
  <div id="greenCastle" class="castle">üè∞</div>
  <div id="winner"></div>
</div>

<script>
let soldiers=[]
let health={
  red:300,
  blue:300,
  green:300
}
let alive={
  red:true,
  blue:true,
  green:true
}

function spawn(team,amount){
  for(let i=0;i<amount;i++){
    soldiers.push({
      id:Math.random(),
      team,
      x: team==="red"?10:90,
      y: team==="red"?50: team==="blue"?30:70,
      speed:0.3+Math.random()*0.3
    })
  }
}

async function checkSpawn(){
  const res=await fetch("/spawn")
  const data=await res.json()
  data.forEach(s=>{
    if(alive[s.team]) spawn(s.team,s.amount)
  })
}

function update(){
  soldiers.forEach(s=>{
    if(!alive[s.team]) return

    if(s.team==="red") s.x+=s.speed
    else s.x-=s.speed

    const enemies=soldiers.filter(e=>e.team!==s.team)

    enemies.forEach(e=>{
      if(Math.abs(s.x-e.x)<1 && Math.abs(s.y-e.y)<1){
        s.dead=true
        e.dead=true
      }
    })

    if(s.x<5 || s.x>95){
      const target=s.team==="red"?"blue":"red"
      if(alive[target]){
        health[target]-=2
        if(health[target]<=0){
          alive[target]=false
        }
      }
      s.dead=true
    }
  })

  soldiers=soldiers.filter(s=>!s.dead)

  const aliveTeams=Object.keys(alive).filter(t=>alive[t])
  if(aliveTeams.length===1){
    document.getElementById("winner").style.display="block"
    document.getElementById("winner").innerText=
      "üî• "+aliveTeams[0].toUpperCase()+" TAKIMI ZAFER üî•"
    setTimeout(()=>location.reload(),5000)
  }
}

function render(){
  document.querySelectorAll(".soldier").forEach(e=>e.remove())

  soldiers.forEach(s=>{
    const el=document.createElement("div")
    el.className="soldier"
    el.innerText="‚öîÔ∏è"
    el.style.left=s.x+"%"
    el.style.top=s.y+"%"
    el.style.color=s.team
    document.body.appendChild(el)
  })
}

function loop(){
  update()
  render()
  requestAnimationFrame(loop)
}

setInterval(checkSpawn,500)
loop()
</script>
</body>
</html>
